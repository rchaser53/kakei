# CSV家計簿メール送信スクリプト

`packages/backend/src/csv-mail-sender.ts` は、CSVファイルからレシートデータを読み取り、月次家計簿レポートをメールで送信するスクリプトです。

## CSVフォーマット

CSVファイルは以下のフォーマットに従ってください：

```
日付,店名,金額
```

### 例:
```csv
日付,店名,金額
9/01,スーパーA,2480
9/03,コンビニB,1200
9/05,ドラッグストアC,850
9/07,レストランD,3500
9/10,スーパーA,1980
```

### フォーマット詳細:
- **日付**: `mm/dd` 形式（例: `9/01`, `12/25`）
- **店名**: 店舗名（文字列）
- **金額**: 購入金額（数値、¥や,は自動で除去されます）

## 使用方法

### 1. 環境設定

Gmail API の認証情報が必要です：
- `credentials.json`: Google Cloud Console から取得
- `token.json`: 初回実行時に自動生成
- 環境変数 `GMAIL_TO_EMAIL`: 送信先メールアドレス

### 2. サンプルCSVファイルの生成

```bash
cd packages/backend
npx tsx src/csv-mail-sender.ts --sample
```

これにより `sample-receipts.csv` が生成されます。

### 3. メール送信

```bash
cd packages/backend
npx tsx src/csv-mail-sender.ts <CSVファイルパス>
```

#### 例:
```bash
# 相対パスで指定
npx tsx src/csv-mail-sender.ts receipts.csv

# 絶対パスで指定
npx tsx src/csv-mail-sender.ts /path/to/receipts.csv
```

## 生成されるレポート

スクリプトは以下の情報を含むHTMLレポートを生成します：

- **請求金額**: 合計金額の1/2を10円単位で切り下げ
- **合計金額**: 全レシートの金額の合計
- **レシート一覧**: 日付順に並んだテーブル
  - 日付
  - 店舗名
  - 金額

### レポート例:
```
=== 2025年9月の家計簿 ===

========================
【請求金額】 5000円 (合計金額の1/2を10円単位で切り下げ)
【合計金額】 10010円
========================

合計 5 件のレシート
[HTMLテーブル形式でレシート詳細を表示]
========================
```

## エラー処理

- **CSV形式エラー**: 列数不足や無効な金額の行はスキップされます
- **日付形式エラー**: mm/dd形式でない日付はスキップされます
- **ファイル不存在**: 指定されたCSVファイルが見つからない場合はエラーメッセージを表示

## 注意事項

1. **認証**: 初回実行時はブラウザでGoogle認証が必要です
2. **送信確認**: メール送信前に確認プロンプトが表示されます
3. **レート制限**: Gmail APIのレート制限を考慮して実装されています
4. **日本語対応**: 件名と本文は適切にエンコードされます

## 依存関係

- `@google-cloud/local-auth`: Google OAuth 認証
- `googleapis`: Gmail API
- `dotenv`: 環境変数管理

## 拡張可能な機能

- 年月の指定（現在は現在の年月を使用）
- 複数の宛先への送信
- カスタム件名の設定
- 異なる通貨フォーマットの対応